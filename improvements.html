<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST - Uw Verbeterde CV</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js voor markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.0/marked.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto">
        <!-- Debug Info -->
        <div id="debugInfo" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4 rounded">
            <p class="font-bold">🔍 Debug Info:</p>
            <p id="debugText" class="text-sm font-mono">Loading...</p>
        </div>
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-2 pulse-animation">Uw Verbeterde CV</h1>
            <p class="text-white text-lg">AI-gestuurde optimalisatie resultaten</p>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Match Score -->
            <div class="bg-white rounded-2xl p-8 text-center shadow-xl">
                <div id="matchScore" class="text-6xl font-bold text-purple-600 mb-2">--</div>
                <div class="text-gray-600 font-semibold text-lg">Match Score</div>
            </div>
            
            <!-- Changes Count -->
            <div class="bg-white rounded-2xl p-8 text-center shadow-xl">
                <div id="changesCount" class="text-6xl font-bold text-purple-600 mb-2">--</div>
                <div class="text-gray-600 font-semibold text-lg">Wijzigingen Gemaakt</div>
            </div>
            
            <!-- Impact -->
            <div class="bg-white rounded-2xl p-8 text-center shadow-xl">
                <div id="avgImpact" class="text-6xl font-bold text-purple-600 mb-2">--</div>
                <div class="text-gray-600 font-semibold text-lg">Gem. Impact</div>
            </div>
        </div>
        
        <!-- Buttons -->
        <div class="flex gap-4 mb-8 justify-center flex-wrap">
            <button onclick="window.print()" class="bg-white hover:bg-gray-100 text-purple-600 font-semibold px-6 py-3 rounded-lg shadow-lg">
                📄 Download PDF
            </button>
            <button onclick="copyContent()" class="bg-white hover:bg-gray-100 text-purple-600 font-semibold px-6 py-3 rounded-lg shadow-lg">
                📋 Kopieer CV
            </button>
            <a href="index.html" class="bg-white hover:bg-gray-100 text-purple-600 font-semibold px-6 py-3 rounded-lg shadow-lg inline-block">
                🔄 Nieuw CV
            </a>
        </div>
        
        <!-- Content -->
        <div class="space-y-6">
            <!-- Changes Overview -->
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">📝 Wat Is Veranderd & Waarom</h2>
                <div id="changesContent" class="prose prose-lg max-w-none"></div>
            </div>
            
            <!-- Improved CV -->
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">📄 Verbeterd CV</h2>
                <div id="cvContent" class="prose prose-lg max-w-none"></div>
            </div>
            
            <!-- Cover Letter -->
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">✉️ Motivatiebrief</h2>
                <div id="coverLetterContent" class="prose prose-lg max-w-none"></div>
            </div>
            
            <!-- Tips -->
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-purple-600">💡 Recruiter Tips</h2>
                <div id="tipsContent" class="prose prose-lg max-w-none"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // ULTRA SIMPEL SCRIPT DAT ALTIJD WERKT
        // ========================================
        
        console.log('🚀 TEST improvements page loaded');
        
        let debugLog = [];
        function addDebug(msg) {
            debugLog.push(msg);
            console.log(msg);
            document.getElementById('debugText').innerHTML = debugLog.join('<br>');
        }
        
        addDebug('✅ Script started');
        
        // Stap 1: Haal data op
        const rawData = sessionStorage.getItem('cvAnalysisResult');
        addDebug(`📦 SessionStorage data: ${rawData ? 'FOUND!' : 'NOT FOUND!'}`);
        
        if (!rawData) {
            addDebug('❌ ERROR: No data in sessionStorage!');
            alert('❌ Geen data gevonden!\n\nGa terug naar de homepage en analyseer je CV opnieuw.');
            // DON'T redirect, so user can see debug info
        }
        
        let data = null;
        try {
            data = JSON.parse(rawData);
            addDebug(`✅ Data parsed successfully`);
            addDebug(`📊 Keys: ${Object.keys(data).join(', ')}`);
            addDebug(`📏 changesOverview: ${data.changesOverview?.length || 0} chars`);
            addDebug(`📏 improvedCV: ${data.improvedCV?.length || 0} chars`);
        } catch (e) {
            addDebug(`❌ Parse error: ${e.message}`);
        }
        
        // Stap 2: Extract stats - SUPER AGGRESSIVE PATTERNS
        function extractStats(text) {
            addDebug('🔍 Starting stats extraction...');
            
            if (!text) {
                addDebug('⚠️ No text to extract from');
                return { matchScore: 0, changesCount: 0 };
            }
            
            addDebug(`📏 Text length: ${text.length}`);
            addDebug(`📝 First 200 chars: ${text.substring(0, 200)}`);
            
            let matchScore = 0;
            let changesCount = 0;
            
            // MATCH SCORE - Try EVERYTHING
            const matchPatterns = [
                /match\s*score[:\s]*(\d+)%/i,
                /job\s*match[:\s]*(\d+)%/i,
                /afstemming[:\s]*(\d+)%/i,
                /score[:\s]*(\d+)%/i,
                /(\d+)%\s*match/i,
                /percentage[:\s]*(\d+)/i,
                /rating[:\s]*(\d+)/i
            ];
            
            for (let i = 0; i < matchPatterns.length; i++) {
                const match = text.match(matchPatterns[i]);
                if (match && match[1]) {
                    matchScore = parseInt(match[1]);
                    addDebug(`✅ Match score: ${matchScore}% (pattern ${i})`);
                    break;
                }
            }
            
            if (matchScore === 0) {
                addDebug('⚠️ No match score pattern found, trying loose numbers...');
                // Try to find ANY percentage in first 500 chars
                const anyPercent = text.substring(0, 500).match(/(\d{1,3})%/);
                if (anyPercent) {
                    matchScore = parseInt(anyPercent[1]);
                    addDebug(`💡 Found percentage: ${matchScore}%`);
                }
            }
            
            // CHANGES COUNT
            const changePatterns = [
                /(\d+)\s*changes/i,
                /(\d+)\s*wijzigingen/i,
                /total[:\s]*(\d+)/i,
                /totaal[:\s]*(\d+)/i,
                /aantal[:\s]*(\d+)/i
            ];
            
            for (let i = 0; i < changePatterns.length; i++) {
                const match = text.match(changePatterns[i]);
                if (match && match[1]) {
                    changesCount = parseInt(match[1]);
                    addDebug(`✅ Changes count: ${changesCount} (pattern ${i})`);
                    break;
                }
            }
            
            // Fallback: Count numbered items
            if (changesCount === 0) {
                const numbered = (text.match(/^###\s*\d+\./gm) || []).length;
                if (numbered > 0) {
                    changesCount = numbered;
                    addDebug(`💡 Counted ${numbered} ### headers`);
                }
            }
            
            // Fallback: Count ### 1. style headers
            if (changesCount === 0) {
                const sections = (text.match(/###\s*\d+\./g) || []).length;
                if (sections > 0) {
                    changesCount = sections;
                    addDebug(`💡 Counted ${sections} section headers`);
                }
            }
            
            addDebug(`📊 FINAL: matchScore=${matchScore}%, changesCount=${changesCount}`);
            return { matchScore, changesCount };
        }
        
        // Stap 3: Update UI
        function updateStats() {
            addDebug('📊 Updating stats in UI...');
            
            const text = (data?.changesOverview || data?.improvedCV || '');
            const stats = extractStats(text);
            
            document.getElementById('matchScore').textContent = stats.matchScore + '%';
            document.getElementById('changesCount').textContent = stats.changesCount;
            document.getElementById('avgImpact').textContent = stats.changesCount > 0 ? '✓' : '--';
            
            addDebug('✅ Stats updated in DOM');
        }
        
        // Stap 4: Render markdown
        function renderMarkdown(text) {
            if (!text) return '<p class="text-gray-400 italic">Geen content</p>';
            
            try {
                if (typeof marked !== 'undefined') {
                    addDebug('✅ Using marked.js');
                    return marked.parse(text);
                }
            } catch (e) {
                addDebug(`⚠️ Marked.js error: ${e.message}`);
            }
            
            // Fallback
            addDebug('⚠️ Using basic markdown fallback');
            return text
                .replace(/^### (.+)$/gm, '<h3 class="text-2xl font-bold mt-6 mb-3">$1</h3>')
                .replace(/^## (.+)$/gm, '<h2 class="text-3xl font-bold mt-8 mb-4">$1</h2>')
                .replace(/\*\*(.+?)\*\*/g, '<strong class="font-bold">$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^[-•*] (.+)$/gm, '<li class="ml-4">$1</li>')
                .replace(/\n\n/g, '</p><p class="mb-4">')
                .replace(/^(.+)$/gm, '<p class="mb-4">$1</p>');
        }
        
        // Stap 5: Display content
        function displayContent() {
            addDebug('🎨 Displaying content...');
            
            if (!data) {
                addDebug('❌ No data to display');
                return;
            }
            
            updateStats();
            
            const sections = {
                'changesContent': data.changesOverview,
                'cvContent': data.improvedCV,
                'coverLetterContent': data.coverLetter,
                'tipsContent': data.recruiterTips
            };
            
            for (const [id, content] of Object.entries(sections)) {
                const el = document.getElementById(id);
                if (el && content) {
                    el.innerHTML = renderMarkdown(content);
                    addDebug(`✅ Rendered ${id} (${content.length} chars)`);
                } else {
                    addDebug(`⚠️ Missing ${id}`);
                }
            }
            
            addDebug('🎉 ALL DONE!');
        }
        
        // Copy function
        function copyContent() {
            const cvText = document.getElementById('cvContent').innerText;
            navigator.clipboard.writeText(cvText).then(() => {
                alert('✅ CV gekopieerd!');
            });
        }
        
        // Initialize
        if (data) {
            displayContent();
        }
    </script>
</body>
</html>
