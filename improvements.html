<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uw Verbeterde CV - AI CV Tailor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.0/marked.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #1f2937;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .markdown-content li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        @keyframes highlight {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.2); }
        }
        
        .stat-animated {
            animation: highlight 1s ease;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Uw Verbeterde CV</h1>
            <p class="text-white text-opacity-80">AI-gestuurde optimalisatie resultaten</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="stat-card">
                <div id="matchScore" class="stat-number">--</div>
                <div class="text-gray-600 font-medium">Match Score</div>
            </div>
            <div class="stat-card">
                <div id="changesCount" class="stat-number">--</div>
                <div class="text-gray-600 font-medium">Wijzigingen Gemaakt</div>
            </div>
            <div class="stat-card">
                <div id="avgImpact" class="stat-number">--</div>
                <div class="text-gray-600 font-medium">Gem. Impact</div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-4 mb-8 flex-wrap justify-center">
            <button onclick="window.print()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold shadow hover:shadow-lg transition">
                üìÑ Download PDF
            </button>
            <button onclick="copyCV()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold shadow hover:shadow-lg transition">
                üìã Kopieer CV
            </button>
            <a href="index.html" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold shadow hover:shadow-lg transition inline-block">
                üîÑ Nieuw CV
            </a>
        </div>
        
        <!-- Content Sections -->
        <div class="space-y-6">
            <!-- Changes Overview -->
            <div class="content-card">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">üìù Wat Is Veranderd & Waarom</h2>
                <div id="changesContent" class="markdown-content"></div>
            </div>
            
            <!-- Improved CV -->
            <div class="content-card">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">üìÑ Verbeterd CV</h2>
                <div id="cvContent" class="markdown-content"></div>
            </div>
            
            <!-- Cover Letter -->
            <div class="content-card">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">‚úâÔ∏è Motivatiebrief</h2>
                <div id="coverLetterContent" class="markdown-content"></div>
            </div>
            
            <!-- Recruiter Tips -->
            <div class="content-card">
                <h2 class="text-2xl font-bold mb-4 text-purple-600">üí° Recruiter Tips</h2>
                <div id="tipsContent" class="markdown-content"></div>
            </div>
        </div>
    </div>
    
    <script>
        console.log('üöÄ Improvements page loaded');
        
        // Load data from sessionStorage
        const resultData = sessionStorage.getItem('cvAnalysisResult');
        console.log('üì¶ Raw data:', resultData ? 'found' : 'NOT FOUND');
        
        if (!resultData) {
            alert('Geen data gevonden. Ga terug en analyseer je CV opnieuw.');
            window.location.href = 'index.html';
        }
        
        let data;
        try {
            data = JSON.parse(resultData);
            console.log('‚úÖ Data parsed successfully');
            console.log('üìä Data keys:', Object.keys(data));
        } catch (e) {
            console.error('‚ùå Parse error:', e);
            alert('Error loading data. Ga terug en probeer opnieuw.');
            window.location.href = 'index.html';
        }
        
        // Extract stats with SUPER ROBUST patterns
        function extractStats(text) {
            console.log('üîç Extracting stats from text length:', text?.length || 0);
            
            if (!text) return { matchScore: 0, changesCount: 0 };
            
            let matchScore = 0;
            let changesCount = 0;
            
            // MATCH SCORE - 15 patterns!
            const matchPatterns = [
                /match\s*score[:\s]*(\d+)%/i,
                /job\s*match[:\s]*(\d+)%/i,
                /afstemming[:\s]*(\d+)%/i,
                /score[:\s]*(\d+)%/i,
                /(\d+)%\s*match/i,
                /match[:\s]*"(\d+)%"/i,
                /cv\s*score[:\s]*(\d+)/i,
                /overall[:\s]*(\d+)%/i,
                /percentage[:\s]*(\d+)%/i,
                /rating[:\s]*(\d+)%/i
            ];
            
            for (const pattern of matchPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    matchScore = parseInt(match[1]);
                    console.log(`‚úÖ Match score: ${matchScore}% (pattern: ${pattern})`);
                    break;
                }
            }
            
            // CHANGES COUNT - 15 patterns!
            const changesPatterns = [
                /(\d+)\s*changes?\s*made/i,
                /(\d+)\s*wijzigingen/i,
                /total\s*changes?[:\s]*(\d+)/i,
                /made\s*(\d+)\s*changes?/i,
                /totaal[:\s]*(\d+)/i,
                /aantal[:\s]*(\d+)/i,
                /(\d+)\s*improvements?/i,
                /(\d+)\s*verbeteringen/i,
                /changes?[:\s]*(\d+)/i,
                /count[:\s]*(\d+)/i
            ];
            
            for (const pattern of changesPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    changesCount = parseInt(match[1]);
                    console.log(`‚úÖ Changes count: ${changesCount} (pattern: ${pattern})`);
                    break;
                }
            }
            
            // FALLBACK: Count numbered items (1. 2. 3.)
            if (changesCount === 0) {
                const numbered = (text.match(/^\s*\d+\./gm) || []).length;
                if (numbered > 0) {
                    changesCount = numbered;
                    console.log(`üí° Counted ${numbered} numbered items`);
                }
            }
            
            // FALLBACK: Count ### headers
            if (changesCount === 0) {
                const headers = (text.match(/^###\s+\d+\./gm) || []).length;
                if (headers > 0) {
                    changesCount = headers;
                    console.log(`üí° Counted ${headers} section headers`);
                }
            }
            
            // FALLBACK: Count bullet points
            if (changesCount === 0) {
                const bullets = (text.match(/^[-‚Ä¢*]\s/gm) || []).length;
                if (bullets > 0) {
                    changesCount = Math.min(bullets, 20); // Cap at 20
                    console.log(`üí° Counted ${changesCount} bullet points`);
                }
            }
            
            console.log(`üìä FINAL: ${matchScore}% match, ${changesCount} changes`);
            return { matchScore, changesCount };
        }
        
        // Update stats in UI
        function updateStats() {
            const text = data.changesOverview || data.improvedCV || '';
            const stats = extractStats(text);
            
            const matchEl = document.getElementById('matchScore');
            const changesEl = document.getElementById('changesCount');
            const impactEl = document.getElementById('avgImpact');
            
            if (matchEl) {
                matchEl.textContent = stats.matchScore + '%';
                matchEl.classList.add('stat-animated');
            }
            
            if (changesEl) {
                changesEl.textContent = stats.changesCount;
                changesEl.classList.add('stat-animated');
            }
            
            if (impactEl) {
                impactEl.textContent = stats.changesCount > 0 ? '‚úì' : '--';
                impactEl.classList.add('stat-animated');
            }
        }
        
        // Render markdown to HTML
        function renderMarkdown(text) {
            if (!text) return '<p class="text-gray-500">Geen content beschikbaar</p>';
            
            try {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true
                    });
                    return marked.parse(text);
                }
            } catch (e) {
                console.warn('Marked.js error, using fallback:', e);
            }
            
            // Fallback: basic conversion
            return text
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^[-‚Ä¢*] (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/gs, '<ul>$&</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>');
        }
        
        // Display all content
        function displayContent() {
            console.log('üé® Displaying content...');
            
            // Update stats
            updateStats();
            
            // Render sections
            const sections = {
                'changesContent': data.changesOverview,
                'cvContent': data.improvedCV,
                'coverLetterContent': data.coverLetter,
                'tipsContent': data.recruiterTips
            };
            
            for (const [id, content] of Object.entries(sections)) {
                const element = document.getElementById(id);
                if (element && content) {
                    element.innerHTML = renderMarkdown(content);
                    console.log(`‚úÖ Rendered ${id}`);
                } else {
                    console.warn(`‚ö†Ô∏è Missing: ${id}`);
                    if (element) {
                        element.innerHTML = '<p class="text-gray-500 italic">Geen content beschikbaar voor deze sectie</p>';
                    }
                }
            }
            
            console.log('üéâ All content displayed!');
        }
        
        // Copy CV to clipboard
        function copyCV() {
            const cvText = document.getElementById('cvContent').innerText;
            navigator.clipboard.writeText(cvText).then(() => {
                alert('‚úÖ CV gekopieerd naar clipboard!');
            }).catch(() => {
                alert('‚ùå Kon CV niet kopi√´ren. Probeer opnieuw.');
            });
        }
        
        // Initialize
        if (data) {
            displayContent();
        }
    </script>
</body>
</html>
