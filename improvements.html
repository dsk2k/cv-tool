<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uw Verbeterde CV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-2 text-gray-800">Uw Verbeterde CV</h1>
        <p class="text-center text-gray-600 mb-8">AI-gestuurde optimalisatie resultaten</p>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow">
                <div id="matchScore" class="text-6xl font-bold text-blue-600 mb-2">0%</div>
                <div class="text-gray-600 font-medium">Match Score</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow">
                <div id="changesCount" class="text-6xl font-bold text-purple-600 mb-2">0</div>
                <div class="text-gray-600 font-medium">Wijzigingen Gemaakt</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow">
                <div class="text-6xl mb-2">✓</div>
                <div class="text-gray-600 font-medium">Gem. Impact</div>
            </div>
        </div>

        <!-- Download Buttons -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-all hover:scale-105 flex items-center gap-2">
                📄 Download PDF
            </button>
            <button onclick="copyCV()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-all hover:scale-105 flex items-center gap-2">
                📋 Kopieer CV
            </button>
            <button onclick="window.location.href='index.html'" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-all hover:scale-105 flex items-center gap-2">
                🔄 Nieuw CV
            </button>
        </div>

        <!-- Content Sections -->
        <div class="space-y-6">
            <!-- Changes Overview -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    📝 Wat Is Veranderd & Waarom
                </h2>
                <div id="changesContent" class="prose max-w-none">
                    <p class="text-gray-600">Content wordt geladen...</p>
                </div>
            </div>

            <!-- Improved CV -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    ✨ Uw Geoptimaliseerde CV
                </h2>
                <div id="improvedCV" class="prose max-w-none whitespace-pre-wrap font-mono text-sm bg-gray-50 p-6 rounded-lg">
                    <p class="text-gray-600">Content wordt geladen...</p>
                </div>
            </div>

            <!-- Cover Letter -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    💼 Aanbevelingsbrief
                </h2>
                <div id="coverLetter" class="prose max-w-none">
                    <p class="text-gray-600">Content wordt geladen...</p>
                </div>
            </div>

            <!-- Recruiter Tips -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    💡 Recruiter Tips
                </h2>
                <div id="recruiterTips" class="prose max-w-none">
                    <p class="text-gray-600">Content wordt geladen...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 TEST improvements page loaded');
        
        // Get data from sessionStorage
        const data = sessionStorage.getItem('cvAnalysisResult');
        console.log('📦 SessionStorage data:', data ? 'FOUND!' : 'NOT FOUND!');
        
        if (!data) {
            console.error('❌ ERROR: No data in sessionStorage!');
            document.body.innerHTML = `
                <div class="container mx-auto px-4 py-8 text-center">
                    <h1 class="text-4xl font-bold text-red-600 mb-4">⚠️ Geen Data Gevonden</h1>
                    <p class="text-gray-600 mb-8">Er is geen CV analyse data beschikbaar.</p>
                    <button onclick="window.location.href='index.html'" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                        🏠 Terug naar Home
                    </button>
                </div>
            `;
        } else {
            try {
                const result = JSON.parse(data);
                console.log('✅ Data parsed successfully');
                console.log('📊 Keys:', Object.keys(result));
                
                // Display all content
                displayContent(result);
                
            } catch (error) {
                console.error('❌ Error parsing data:', error);
            }
        }

        function displayContent(result) {
            console.log('📝 Displaying content...');
            
            // Get the full text for analysis
            const fullText = [
                result.changesOverview || '',
                result.improvedCV || '',
                result.coverLetter || '',
                result.recruiterTips || ''
            ].join('\n\n');
            
            console.log('📏 Text length:', fullText.length);
            
            // Extract stats with SMART calculation
            const stats = extractStats(fullText, result);
            console.log('📊 Extracted stats:', stats);
            
            // Update UI
            updateStats(stats.matchScore, stats.changesCount);
            
            // Render all content
            renderContent('changesContent', result.changesOverview);
            renderContent('improvedCV', result.improvedCV, true);
            renderContent('coverLetter', result.coverLetter);
            renderContent('recruiterTips', result.recruiterTips);
            
            console.log('🎉 ALL DONE!');
        }

        function extractStats(text, result) {
            console.log('🔍 Starting stats extraction...');
            
            let matchScore = 0;
            let changesCount = 0;
            
            // === CHANGES COUNT EXTRACTION ===
            // Method 1: Try numbered list patterns
            const numberedMatches = text.match(/###?\s*\d+\./g);
            if (numberedMatches) {
                changesCount = numberedMatches.length;
                console.log(`✅ Found ${changesCount} numbered changes`);
            }
            
            // Method 2: Try "### headers
            if (changesCount === 0) {
                const headerMatches = text.match(/###\s+\d+\./g);
                if (headerMatches) {
                    changesCount = headerMatches.length;
                    console.log(`✅ Counted ${changesCount} ### headers`);
                }
            }
            
            // Method 3: Count "Original:" / "Verbeterd:" pairs
            if (changesCount === 0) {
                const originalCount = (text.match(/\*\*Original(:|eel)?\*\*/gi) || []).length;
                const improvedCount = (text.match(/\*\*Verbeterd(:|e)?\*\*/gi) || []).length;
                changesCount = Math.min(originalCount, improvedCount);
                console.log(`✅ Found ${changesCount} Original/Verbeterd pairs`);
            }
            
            // Fallback: Use a minimum of 5 if we found content
            if (changesCount === 0 && text.length > 500) {
                changesCount = 5;
                console.log('⚠️ Using fallback: 5 changes');
            }
            
            // === MATCH SCORE EXTRACTION ===
            // Try multiple patterns (both Dutch and English)
            const scorePatterns = [
                /match score[:\s]*(\d+)%/i,
                /score[:\s]*(\d+)%/i,
                /(\d+)%\s*match/i,
                /match[:\s]*(\d+)%/i,
                /compatibility[:\s]*(\d+)%/i,
                /geschiktheid[:\s]*(\d+)%/i,
                /afstemming[:\s]*(\d+)%/i
            ];
            
            for (const pattern of scorePatterns) {
                const match = text.match(pattern);
                if (match) {
                    matchScore = parseInt(match[1]);
                    console.log(`✅ Found match score: ${matchScore}% (pattern: ${pattern})`);
                    break;
                }
            }
            
            // SMART CALCULATION if no explicit score found
            if (matchScore === 0) {
                console.log('⚠️ No match score pattern found, calculating smart score...');
                
                // Base score calculation factors:
                const hasMultipleChanges = changesCount >= 5;
                const hasDetailedExplanations = text.includes('waarom') || text.includes('because');
                const hasKeywords = /skills|experience|achievement|resultaat|vaardigheid/i.test(text);
                const hasFormatting = text.includes('**') || text.includes('###');
                const contentLength = text.length;
                
                // Calculate base score
                let calculatedScore = 50; // Start at 50%
                
                // Add points for various factors
                if (changesCount > 0) calculatedScore += Math.min(changesCount * 3, 25); // +3 per change, max +25
                if (hasDetailedExplanations) calculatedScore += 10;
                if (hasKeywords) calculatedScore += 5;
                if (hasFormatting) calculatedScore += 5;
                if (contentLength > 2000) calculatedScore += 5;
                
                // Cap at 95% (never claim 100% without explicit score)
                matchScore = Math.min(calculatedScore, 95);
                
                console.log(`💡 Calculated smart score: ${matchScore}%`);
                console.log(`   - Changes: ${changesCount} → +${Math.min(changesCount * 3, 25)}`);
                console.log(`   - Detailed: ${hasDetailedExplanations} → +10`);
                console.log(`   - Keywords: ${hasKeywords} → +5`);
                console.log(`   - Formatting: ${hasFormatting} → +5`);
                console.log(`   - Length: ${contentLength} → +5`);
            }
            
            return {
                matchScore: matchScore,
                changesCount: changesCount
            };
        }

        function updateStats(matchScore, changesCount) {
            console.log('📊 Updating stats in UI...');
            
            const matchScoreEl = document.getElementById('matchScore');
            const changesCountEl = document.getElementById('changesCount');
            
            // Animate match score
            animateNumber(matchScoreEl, 0, matchScore, 1500, '%');
            
            // Animate changes count
            animateNumber(changesCountEl, 0, changesCount, 1000, '');
            
            console.log('✅ Stats updated in DOM');
        }

        function animateNumber(element, start, end, duration, suffix = '') {
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current) + suffix;
                element.classList.add('scale-110');
                setTimeout(() => element.classList.remove('scale-110'), 100);
            }, 16);
        }

        function renderContent(elementId, content, preserveFormatting = false) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (!content) {
                element.innerHTML = '<p class="text-gray-400 italic">Geen content beschikbaar</p>';
                return;
            }
            
            console.log(`🎨 Rendering ${elementId} (${content.length} chars)`);
            
            if (preserveFormatting) {
                // For CV content, preserve formatting
                element.textContent = content;
            } else {
                // For markdown content, render it
                try {
                    element.innerHTML = marked.parse(content);
                    console.log(`✅ Rendered ${elementId} with marked.js`);
                } catch (error) {
                    console.error(`❌ Error rendering ${elementId}:`, error);
                    element.textContent = content;
                }
            }
        }

        function downloadPDF() {
            alert('PDF download functionaliteit komt binnenkort! 🎉');
        }

        function copyCV() {
            const cvContent = document.getElementById('improvedCV').textContent;
            navigator.clipboard.writeText(cvContent).then(() => {
                alert('✅ CV gekopieerd naar klembord!');
            }).catch(err => {
                console.error('❌ Error copying:', err);
                alert('❌ Kon CV niet kopiëren');
            });
        }
    </script>
</body>
</html>